<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aervo ‚Äì Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
        min-height: 100vh;
      }
      .nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 32px;
        background: rgba(5, 8, 23, 0.96);
        backdrop-filter: blur(14px);
        z-index: 100;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .nav-brand {
        font-weight: 600;
        letter-spacing: 4px;
        font-size: 14px;
        color: #8fbfff;
      }
      .nav-center {
        display: flex;
        gap: 24px;
        align-items: center;
      }
      .nav-tab {
        padding: 8px 16px;
        border-radius: 8px;
        color: #9ca7d6;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      .nav-tab:hover {
        background: rgba(143, 191, 255, 0.08);
        color: #e5ecff;
      }
      .nav-tab.active {
        background: rgba(143, 191, 255, 0.15);
        border-color: rgba(143, 191, 255, 0.3);
        color: #e5ecff;
      }
      .nav-right {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .shop-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(34, 197, 94, 0.15);
        color: #6ee7b7;
        font-size: 11px;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }
      .btn-logout {
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid #3a4a7c;
        background: transparent;
        color: #dfe7ff;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-logout:hover {
        background: #1a2237;
        border-color: #4a5a8c;
      }
      .container {
        padding: 88px 32px 48px;
        max-width: 1600px;
        margin: 0 auto;
      }
      .welcome {
        margin-bottom: 32px;
      }
      .welcome h1 {
        font-size: 32px;
        margin: 0 0 8px;
        color: #f9fafb;
      }
      .welcome p {
        margin: 0;
        font-size: 15px;
        color: #9ca7d6;
      }
      .ai-banner {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 32px;
        border: 1px solid rgba(59, 130, 246, 0.3);
        box-shadow: 0 10px 40px rgba(59, 130, 246, 0.2);
      }
      .ai-banner-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }
      .ai-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .ai-banner h2 {
        font-size: 18px;
        color: white;
        margin: 0;
      }
      .insight-item {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 14px;
        line-height: 1.6;
      }
      .insight-item:last-child {
        margin-bottom: 0;
      }
      .insight-priority {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 8px;
      }
      .priority-high {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
      }
      .priority-medium {
        background: rgba(251, 191, 36, 0.2);
        color: #fde047;
      }
      .priority-low {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
      }
      .grid-4 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }
      .card {
        background: radial-gradient(circle at top left, #1e293b, #0f172a);
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        padding: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }
      .card h3 {
        font-size: 14px;
        color: #9ca7d6;
        margin: 0 0 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .stat-large {
        font-size: 42px;
        font-weight: 700;
        color: #60a5fa;
        margin: 8px 0;
        line-height: 1;
      }
      .stat-change {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        padding: 4px 8px;
        border-radius: 6px;
        margin-top: 8px;
      }
      .stat-change.positive {
        background: rgba(34, 197, 94, 0.15);
        color: #6ee7b7;
      }
      .stat-change.negative {
        background: rgba(239, 68, 68, 0.15);
        color: #fca5a5;
      }
      .stat-label {
        font-size: 13px;
        color: #64748b;
        margin-top: 4px;
      }
      .action-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .action-item {
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 10px;
        padding: 14px 16px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .action-item:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.3);
      }
      .action-icon {
        width: 32px;
        height: 32px;
        background: rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      .action-content {
        flex: 1;
      }
      .action-title {
        font-size: 14px;
        color: #e5ecff;
        margin-bottom: 2px;
      }
      .action-desc {
        font-size: 12px;
        color: #64748b;
      }
      .chat-container {
        border-radius: 16px;
        padding: 20px;
        height: 380px;
        display: flex;
        flex-direction: column;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 16px;
        padding-right: 8px;
      }
      .chat-message {
        border-radius: 12px;
        padding: 12px 14px;
        margin-bottom: 10px;
        font-size: 14px;
        line-height: 1.5;
      }
      .chat-message.user {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.3);
      }
      .chat-message.ai {
        background: rgba(148, 163, 184, 0.1);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .chat-input-wrapper {
        display: flex;
        gap: 10px;
      }
      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.6);
        color: #e5ecff;
        font-size: 14px;
      }
      .chat-input:focus {
        outline: none;
        border-color: #60a5fa;
      }
      .btn-send {
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th {
        text-align: left;
        padding: 12px;
        font-size: 12px;
        color: #9ca7d6;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        font-weight: 600;
      }
      .data-table td {
        padding: 12px;
        font-size: 13px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      }
      .data-table tr:hover {
        background: rgba(59, 130, 246, 0.05);
      }
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #9ca7d6;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(148, 163, 184, 0.2);
        border-top-color: #60a5fa;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error-banner {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        color: #fca5a5;
        font-size: 14px;
      }
      .connect-cta {
        text-align: center;
        padding: 60px 24px;
      }
      .connect-cta h2 {
        font-size: 24px;
        margin-bottom: 12px;
        color: #e5ecff;
      }
      .connect-cta p {
        color: #9ca7d6;
        font-size: 15px;
        margin-bottom: 24px;
        line-height: 1.6;
      }
      .btn-primary {
        display: inline-block;
        padding: 14px 32px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: white;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        transition: all 0.2s ease;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 40px rgba(59, 130, 246, 0.6);
      }
      /* Mobile Menu */
      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: #e5ecff;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
      }
      .mobile-menu {
        display: none;
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        background: rgba(5, 8, 23, 0.98);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        z-index: 99;
        padding: 16px;
      }
      .mobile-menu.active {
        display: block;
      }
      .mobile-nav-tab {
        display: block;
        width: 100%;
        padding: 12px 16px;
        margin-bottom: 8px;
        border-radius: 8px;
        color: #9ca7d6;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        text-align: left;
      }
      .mobile-nav-tab.active {
        background: rgba(143, 191, 255, 0.15);
        border-color: rgba(143, 191, 255, 0.3);
        color: #e5ecff;
      }

      @media (max-width: 768px) {
        .nav {
          padding: 0 16px;
          height: 56px;
        }
        .nav-brand {
          font-size: 12px;
          letter-spacing: 3px;
        }
        .nav-center {
          display: none;
        }
        .mobile-menu-btn {
          display: block;
        }
        .container {
          padding: 72px 12px 24px;
        }
        .welcome h1 {
          font-size: 22px;
        }
        .welcome p {
          font-size: 14px;
        }
        .grid-4,
        .grid-2 {
          grid-template-columns: 1fr;
          gap: 16px;
        }
        .card {
          padding: 16px;
        }
        .stat-large {
          font-size: 32px;
        }
        .ai-banner {
          padding: 16px;
          margin-bottom: 20px;
        }
        .ai-icon {
          width: 32px;
          height: 32px;
          font-size: 16px;
        }
        .ai-banner h2 {
          font-size: 16px;
        }
        .insight-item {
          padding: 12px;
          font-size: 13px;
        }
        .shop-badge {
          font-size: 10px;
          padding: 4px 8px;
        }
        .btn-logout {
          padding: 6px 12px;
          font-size: 11px;
        }
        .data-table {
          font-size: 12px;
        }
        .data-table th,
        .data-table td {
          padding: 8px 6px;
        }
        .chat-container {
          height: 320px;
        }
        .action-item {
          padding: 12px;
        }
        .action-title {
          font-size: 13px;
        }
        .action-desc {
          font-size: 11px;
        }
        canvas {
          max-height: 220px !important;
        }
      }

      @media (max-width: 480px) {
        .nav {
          height: 52px;
        }
        .nav-brand {
          font-size: 11px;
        }
        .container {
          padding: 68px 8px 20px;
        }
        .welcome h1 {
          font-size: 20px;
        }
        .stat-large {
          font-size: 28px;
        }
        .grid-4 {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }
        .card h3 {
          font-size: 11px;
        }
        .stat-change {
          font-size: 11px;
          padding: 3px 6px;
        }
        .data-table {
          display: block;
          overflow-x: auto;
        }
        canvas {
          max-height: 180px !important;
        }
      }
    </style>
  </head>
  <body>
    <nav class="nav">
      <div class="nav-brand">AERVO</div>
      <div class="nav-center">
        <div class="nav-tab active" data-view="overview">Overview</div>
        <div class="nav-tab" data-view="analytics">Analytics</div>
        <div class="nav-tab" data-view="inventory">Inventory</div>
        <div class="nav-tab" data-view="customers">Customers</div>
      </div>
      <div class="nav-right">
        <a
          href="/dashboard/square"
          id="integrationSwitcher"
          style="
            display: none;
            text-decoration: none;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.25);
            color: #34d399;
            font-size: 12px;
            font-weight: 600;
          "
        >
          ‚¨õ Switch to Square
        </a>
        <div class="shop-badge" id="shopBadge" style="display: none">
          <span>‚óè</span>
          <span id="shopName">Loading...</span>
        </div>
        <a href="/integrations" class="btn-logout" style="text-decoration: none"
          >‚öôÔ∏è Integrations</a
        >
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        <button class="btn-logout" id="logoutBtn">Log out</button>
      </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
      <div class="mobile-nav-tab active" data-view="overview">üìä Overview</div>
      <div class="mobile-nav-tab" data-view="analytics">üìà Analytics</div>
      <div class="mobile-nav-tab" data-view="inventory">üì¶ Inventory</div>
      <div class="mobile-nav-tab" data-view="customers">üë• Customers</div>
    </div>

    <div class="container">
      <div id="content">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading your Aervo dashboard...</div>
        </div>
      </div>
    </div>

    <script>
      const BACKEND_URL = "https://aervo-backend.onrender.com";
      const token = localStorage.getItem("aervo_token");
      if (!token) window.location.href = "/login";

      let currentView = "overview";
      let userData = null;
      let shopData = null;
      let realData = {
        overview: null,
        orders: [],
        inventory: null,
        customers: null,
      };

      // ============= LOGOUT =============
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("aervo_token");
        localStorage.removeItem("aervo_user");
        window.location.href = "/login";
      });

      // ============= MOBILE MENU TOGGLE =============
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const mobileMenu = document.getElementById("mobileMenu");

      mobileMenuBtn.addEventListener("click", () => {
        mobileMenu.classList.toggle("active");
      });

      // ============= TAB NAVIGATION =============
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          currentView = tab.dataset.view;
          document
            .querySelectorAll(".nav-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          renderView(currentView);
        });
      });

      // Mobile tab navigation
      document.querySelectorAll(".mobile-nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          currentView = tab.dataset.view;
          document
            .querySelectorAll(".mobile-nav-tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".nav-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          mobileMenu.classList.remove("active"); // Close menu after selection
          renderView(currentView);
        });
      });

      // ============= LOAD USER + SHOPIFY DATA =============
      async function loadUserData() {
        try {
          const response = await fetch(`${BACKEND_URL}/api/user/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              localStorage.removeItem("aervo_token");
              window.location.href = "/login";
              return;
            }
            throw new Error("Failed to fetch user data");
          }

          const data = await response.json();
          if (!data.success)
            throw new Error(data.message || "Failed to load user data");

          userData = data.user;
          shopData = data.shop;
          // Check if Square is also connected
          const squareStatus = await fetch(
            `${BACKEND_URL}/integrations/square/status?merchantId=${String(userData.id)}`,
            { headers: { Authorization: `Bearer ${token}` } },
          );
          const squareData = await squareStatus.json();
          if (squareData.connected) {
            document.getElementById("integrationSwitcher").style.display =
              "inline-flex";
          }

          if (shopData) {
            document.getElementById("shopBadge").style.display = "flex";
            document.getElementById("shopName").textContent =
              shopData.shopOrigin.replace(".myshopify.com", "");
            await fetchAllShopifyData(shopData.shopOrigin);
          }

          renderView("overview");
        } catch (error) {
          console.error("Dashboard load error:", error);
          document.getElementById("content").innerHTML = `
            <div class="error-banner">
              <strong>‚ö† Error loading dashboard</strong><br>
              ${error.message || "Something went wrong. Please try refreshing the page."}
            </div>
            <div class="card" style="text-align:center;padding:40px;">
              <button class="btn-primary" onclick="location.reload()">Refresh Page</button>
            </div>`;
        }
      }

      // ============= FETCH ALL SHOPIFY DATA =============
      async function fetchAllShopifyData(shop) {
        try {
          const h = { Authorization: `Bearer ${token}` };
          const [oRes, ordRes, invRes, cusRes] = await Promise.all([
            fetch(`${BACKEND_URL}/api/shopify/overview?shop=${shop}`, {
              headers: h,
            }),
            fetch(`${BACKEND_URL}/api/shopify/orders?shop=${shop}&limit=50`, {
              headers: h,
            }),
            fetch(`${BACKEND_URL}/api/shopify/inventory?shop=${shop}`, {
              headers: h,
            }),
            fetch(`${BACKEND_URL}/api/shopify/customers?shop=${shop}`, {
              headers: h,
            }),
          ]);
          const [o, ord, inv, cus] = await Promise.all([
            oRes.json(),
            ordRes.json(),
            invRes.json(),
            cusRes.json(),
          ]);
          realData.overview = o.success ? o.data : null;
          realData.orders = ord.success ? ord.orders : [];
          realData.inventory = inv.success ? inv.inventory : null;
          realData.customers = cus.success ? cus.customers : null;
        } catch (err) {
          console.error("Shopify data error:", err);
        }
      }

      // ============= RENDER ROUTER =============
      function renderView(view) {
        const content = document.getElementById("content");
        if (!shopData && view !== "overview") {
          content.innerHTML = renderConnectShopify();
          return;
        }
        switch (view) {
          case "overview":
            content.innerHTML = renderOverview();
            break;
          case "analytics":
            content.innerHTML = renderAnalytics();
            break;
          case "inventory":
            content.innerHTML = renderInventory();
            break;
          case "customers":
            content.innerHTML = renderCustomers();
            break;
        }
      }

      // ============= RENDER OVERVIEW =============
      function renderOverview() {
        if (!shopData) return renderConnectShopify();
        const d = realData.overview;
        const inv = realData.inventory;
        const orders = realData.orders || [];
        const revenue = d
          ? "$" + parseFloat(d.revenue.total).toLocaleString()
          : "‚Äî";
        const revChange = d ? parseFloat(d.revenue.change) : 0;
        const todayOrders = d ? d.orders.today : "‚Äî";
        const ordChange = d ? parseFloat(d.orders.change) : 0;
        const convRate = d ? d.conversion.rate + "%" : "‚Äî";
        const outOfStock = inv ? inv.outOfStock.length : "‚Äî";
        const lowStock = inv ? inv.lowStock.length : 0;
        const insights = generateInsights(d, inv);

        const html = `
          <div class="welcome">
            <h1>Welcome back, ${userData.companyName}</h1>
            <p>Here's what's happening with your store today</p>
          </div>
          <div class="ai-banner">
            <div class="ai-banner-header">
              <div class="ai-icon">ü§ñ</div>
              <h2>AI Insights &amp; Recommendations</h2>
            </div>
            ${insights
              .map(
                (i) => `
              <div class="insight-item">
                <span class="insight-priority priority-${i.priority}">${i.label}</span>
                <strong>${i.title}</strong> ‚Äî ${i.desc}
              </div>`,
              )
              .join("")}
          </div>
          <div class="grid-4">
            <div class="card">
              <h3>Revenue (30 days)</h3>
              <div class="stat-large">${revenue}</div>
              <div class="stat-change ${revChange >= 0 ? "positive" : "negative"}">
                ${revChange >= 0 ? "‚Üë" : "‚Üì"} ${Math.abs(revChange)}% vs last month
              </div>
            </div>
            <div class="card">
              <h3>Orders Today</h3>
              <div class="stat-large">${todayOrders}</div>
              <div class="stat-change ${ordChange >= 0 ? "positive" : "negative"}">
                ${ordChange >= 0 ? "‚Üë" : "‚Üì"} ${Math.abs(ordChange)}% vs yesterday
              </div>
            </div>
            <div class="card">
              <h3>Conversion Rate</h3>
              <div class="stat-large">${convRate}</div>
              <div class="stat-label">Industry avg: 2.5%</div>
            </div>
            <div class="card">
              <h3>Inventory Alerts</h3>
              <div class="stat-large" style="color:#ef4444">${outOfStock}</div>
              <div class="stat-change negative">‚ö† Out of stock</div>
              <div class="stat-label">${lowStock} low stock items</div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom:24px">
            <h3>Revenue Trend (Last 7 Days)</h3>
            <canvas id="overviewRevenueChart" style="max-height:200px"></canvas>
          </div>
          
          <div class="card" style="margin-bottom:24px">
            <h3>Recent Orders</h3>
            ${renderOrdersTable(orders.slice(0, 10))}
          </div>
          <div class="grid-2">
            <div class="card">
              <h3>Action Center</h3>
              ${renderActionItems(inv)}
            </div>
            <div class="card">
              <h3>Ask Aervo Anything</h3>
              <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                  <div class="chat-message ai">
                    üëã Hi! I'm <strong>Aervo</strong>, your AI business co-pilot. I have full access to your store's real data ‚Äî ask me anything!<br><br>
                    Try asking:<br>
                    ‚Ä¢ <span style="color:#93c5fd;cursor:pointer" onclick="askSuggestion(this)">What are my top 5 products in the last 180 days?</span><br>
                    ‚Ä¢ <span style="color:#93c5fd;cursor:pointer" onclick="askSuggestion(this)">Should I run a sale? If so, what discount would increase sales?</span><br>
                    ‚Ä¢ <span style="color:#93c5fd;cursor:pointer" onclick="askSuggestion(this)">Which products are at risk of running out of stock?</span><br>
                    ‚Ä¢ <span style="color:#93c5fd;cursor:pointer" onclick="askSuggestion(this)">How is my revenue trending month over month?</span>
                  </div>
                </div>
                <div class="chat-input-wrapper">
                  <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything about your store..." />
                  <button class="btn-send" onclick="sendMessage()">Send</button>
                </div>
              </div>
            </div>
          </div>`;

        // Render quick 7-day chart
        setTimeout(() => renderOverviewChart(orders), 100);
        return html;
      }

      // ============= OVERVIEW CHART =============
      function renderOverviewChart(orders) {
        if (!orders || orders.length === 0) return;

        const dailyRevenue = {};
        const today = new Date();

        // Last 7 days
        for (let i = 6; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split("T")[0];
          dailyRevenue[key] = 0;
        }

        orders.forEach((order) => {
          const dateKey = order.created_at.split("T")[0];
          if (dailyRevenue.hasOwnProperty(dateKey)) {
            dailyRevenue[dateKey] += parseFloat(order.total_price || 0);
          }
        });

        const labels = Object.keys(dailyRevenue).map((d) => {
          const date = new Date(d);
          return date.toLocaleDateString("en-US", { weekday: "short" });
        });

        const data = Object.values(dailyRevenue);

        const ctx = document.getElementById("overviewRevenueChart");
        if (ctx) {
          new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Revenue",
                  data,
                  borderColor: "#60a5fa",
                  backgroundColor: "rgba(96, 165, 250, 0.15)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 4,
                  pointHoverRadius: 7,
                  pointBackgroundColor: "#60a5fa",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "rgba(15, 23, 42, 0.95)",
                  titleColor: "#e5ecff",
                  bodyColor: "#9ca7d6",
                  borderColor: "rgba(148, 163, 184, 0.2)",
                  borderWidth: 1,
                  padding: 12,
                  displayColors: false,
                  callbacks: { label: (ctx) => `$${ctx.parsed.y.toFixed(2)}` },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(148, 163, 184, 0.1)" },
                  ticks: {
                    color: "#9ca7d6",
                    callback: (v) => "$" + v.toFixed(0),
                  },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: "#9ca7d6" },
                },
              },
            },
          });
        }
      }

      // ============= RENDER ANALYTICS =============
      function renderAnalytics() {
        const d = realData.overview;
        const orders = realData.orders || [];
        const total = orders.reduce(
          (s, o) => s + parseFloat(o.total_price || 0),
          0,
        );
        const avg = orders.length ? total / orders.length : 0;

        // Render HTML first
        const html = `
          <div class="welcome">
            <h1>Sales Analytics</h1>
            <p>Deep dive into your revenue, orders, and performance trends</p>
          </div>
          <div class="grid-4">
            <div class="card">
              <h3>Total Revenue (30d)</h3>
              <div class="stat-large">$${total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
              ${d ? `<div class="stat-change ${parseFloat(d.revenue.change) >= 0 ? "positive" : "negative"}">${parseFloat(d.revenue.change) >= 0 ? "‚Üë" : "‚Üì"} ${Math.abs(d.revenue.change)}% vs last month</div>` : ""}
            </div>
            <div class="card">
              <h3>Avg Order Value</h3>
              <div class="stat-large">$${avg.toFixed(2)}</div>
            </div>
            <div class="card">
              <h3>Total Orders</h3>
              <div class="stat-large">${orders.length}</div>
            </div>
            <div class="card">
              <h3>Orders Today</h3>
              <div class="stat-large">${d ? d.orders.today : "‚Äî"}</div>
            </div>
          </div>
          
          <div class="grid-2" style="margin-bottom:24px">
            <div class="card">
              <h3>Revenue Trend (Last 30 Days)</h3>
              <canvas id="revenueChart" style="max-height:280px"></canvas>
            </div>
            <div class="card">
              <h3>Top 10 Products by Revenue</h3>
              <canvas id="topProductsChart" style="max-height:280px"></canvas>
            </div>
          </div>
          
          <div class="card">
            <h3>All Recent Orders</h3>
            ${renderOrdersTable(orders.slice(0, 25))}
          </div>`;

        // Schedule chart rendering after DOM updates
        setTimeout(() => renderCharts(orders), 100);

        return html;
      }

      // ============= RENDER CHARTS =============
      function renderCharts(orders) {
        if (!orders || orders.length === 0) return;

        // === REVENUE TREND CHART ===
        const dailyRevenue = {};
        const today = new Date();

        // Initialize last 30 days
        for (let i = 29; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split("T")[0];
          dailyRevenue[key] = 0;
        }

        // Aggregate orders by day
        orders.forEach((order) => {
          const dateKey = order.created_at.split("T")[0];
          if (dailyRevenue.hasOwnProperty(dateKey)) {
            dailyRevenue[dateKey] += parseFloat(order.total_price || 0);
          }
        });

        const labels = Object.keys(dailyRevenue).map((d) => {
          const date = new Date(d);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        });

        const revenueData = Object.values(dailyRevenue);

        const revCtx = document.getElementById("revenueChart");
        if (revCtx) {
          new Chart(revCtx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Revenue",
                  data: revenueData,
                  borderColor: "#60a5fa",
                  backgroundColor: "rgba(96, 165, 250, 0.1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 3,
                  pointHoverRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "rgba(15, 23, 42, 0.95)",
                  titleColor: "#e5ecff",
                  bodyColor: "#9ca7d6",
                  borderColor: "rgba(148, 163, 184, 0.2)",
                  borderWidth: 1,
                  padding: 12,
                  displayColors: false,
                  callbacks: {
                    label: (context) => `$${context.parsed.y.toFixed(2)}`,
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(148, 163, 184, 0.1)" },
                  ticks: {
                    color: "#9ca7d6",
                    callback: (value) => "$" + value.toFixed(0),
                  },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: "#9ca7d6", maxRotation: 45, minRotation: 45 },
                },
              },
            },
          });
        }

        // === TOP PRODUCTS CHART ===
        const productSales = {};
        orders.forEach((order) => {
          (order.line_items || []).forEach((item) => {
            if (!productSales[item.title]) productSales[item.title] = 0;
            productSales[item.title] += parseFloat(item.price) * item.quantity;
          });
        });

        const topProducts = Object.entries(productSales)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        const productLabels = topProducts.map(([name]) =>
          name.length > 25 ? name.substring(0, 25) + "..." : name,
        );
        const productData = topProducts.map(([, revenue]) => revenue);

        const prodCtx = document.getElementById("topProductsChart");
        if (prodCtx && topProducts.length > 0) {
          new Chart(prodCtx, {
            type: "bar",
            data: {
              labels: productLabels,
              datasets: [
                {
                  label: "Revenue",
                  data: productData,
                  backgroundColor: "rgba(96, 165, 250, 0.8)",
                  borderColor: "#60a5fa",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              indexAxis: "y",
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "rgba(15, 23, 42, 0.95)",
                  titleColor: "#e5ecff",
                  bodyColor: "#9ca7d6",
                  borderColor: "rgba(148, 163, 184, 0.2)",
                  borderWidth: 1,
                  padding: 12,
                  displayColors: false,
                  callbacks: {
                    label: (context) => `$${context.parsed.x.toFixed(2)}`,
                  },
                },
              },
              scales: {
                x: {
                  beginAtZero: true,
                  grid: { color: "rgba(148, 163, 184, 0.1)" },
                  ticks: {
                    color: "#9ca7d6",
                    callback: (value) => "$" + value.toFixed(0),
                  },
                },
                y: {
                  grid: { display: false },
                  ticks: { color: "#9ca7d6", font: { size: 11 } },
                },
              },
            },
          });
        }
      }

      // ============= RENDER INVENTORY =============
      function renderInventory() {
        const inv = realData.inventory;
        if (!inv)
          return `<div class="loading"><div class="spinner"></div><div>Loading inventory...</div></div>`;
        const attention = [...inv.outOfStock, ...inv.lowStock].slice(0, 30);
        return `
          <div class="welcome">
            <h1>Inventory Health</h1>
            <p>Monitor stock levels and get smart reorder recommendations</p>
          </div>
          <div class="grid-4">
            <div class="card">
              <h3>Total Products</h3>
              <div class="stat-large">${inv.totalProducts}</div>
              <div class="stat-label">${inv.totalVariants} variants</div>
            </div>
            <div class="card">
              <h3>Out of Stock</h3>
              <div class="stat-large" style="color:#ef4444">${inv.outOfStock.length}</div>
              <div class="stat-change negative">‚ö† Needs attention</div>
            </div>
            <div class="card">
              <h3>Low Stock</h3>
              <div class="stat-large" style="color:#f59e0b">${inv.lowStock.length}</div>
              <div class="stat-label">Below 10 units</div>
            </div>
            <div class="card">
              <h3>In Stock</h3>
              <div class="stat-large">${inv.items.filter((i) => i.status === "in_stock").length}</div>
              <div class="stat-label">Healthy inventory</div>
            </div>
          </div>
          <div class="card">
            <h3>Products Needing Attention</h3>
            ${
              attention.length === 0
                ? `<p style="color:#64748b;padding:20px;text-align:center">üéâ All products are well stocked!</p>`
                : `<div class="table-wrapper"><table class="data-table">
                  <thead><tr><th>Product</th><th>SKU</th><th>Stock</th><th>Price</th><th>Status</th></tr></thead>
                  <tbody>${attention
                    .map(
                      (item) => `
                    <tr>
                      <td>${item.productTitle}${item.variantTitle && item.variantTitle !== "Default Title" ? ` (${item.variantTitle})` : ""}</td>
                      <td>${item.sku || "N/A"}</td>
                      <td style="color:${item.status === "out_of_stock" ? "#ef4444" : "#f59e0b"}">${item.quantity}</td>
                      <td>$${parseFloat(item.price).toFixed(2)}</td>
                      <td><span class="insight-priority priority-${item.status === "out_of_stock" ? "high" : "medium"}">${item.status === "out_of_stock" ? "Out of Stock" : "Low Stock"}</span></td>
                    </tr>`,
                    )
                    .join("")}
                  </tbody>
                </table></div>`
            }
          </div>`;
      }

      // ============= RENDER CUSTOMERS =============
      function renderCustomers() {
        const c = realData.customers;
        const orders = realData.orders || [];

        if (!c)
          return `<div class="loading"><div class="spinner"></div><div>Loading customers...</div></div>`;

        // === ADVANCED CUSTOMER SEGMENTATION ===
        const today = new Date();
        const thirtyDaysAgo = new Date(
          today.getTime() - 30 * 24 * 60 * 60 * 1000,
        );
        const sixtyDaysAgo = new Date(
          today.getTime() - 60 * 24 * 60 * 60 * 1000,
        );

        // Segment customers by value
        const avgLTV = parseFloat(c.avgLifetimeValue);
        const vipCustomers = c.topCustomers.filter(
          (cu) => parseFloat(cu.totalSpent) > avgLTV * 2,
        );
        const regularCustomers = c.topCustomers.filter(
          (cu) =>
            parseFloat(cu.totalSpent) >= avgLTV &&
            parseFloat(cu.totalSpent) <= avgLTV * 2,
        );
        const newCustomers = c.topCustomers.filter(
          (cu) => cu.ordersCount === 1,
        );

        // Calculate at-risk customers (haven't ordered in 60+ days)
        const customerLastOrder = {};
        orders.forEach((order) => {
          if (order.customer && order.customer.id) {
            const orderId = order.customer.id;
            const orderDate = new Date(order.created_at);
            if (
              !customerLastOrder[orderId] ||
              orderDate > customerLastOrder[orderId]
            ) {
              customerLastOrder[orderId] = orderDate;
            }
          }
        });

        const atRiskCount = Object.values(customerLastOrder).filter(
          (date) => date < sixtyDaysAgo,
        ).length;

        // New customers in last 30 days
        const recentCustomerIds = new Set();
        orders.forEach((order) => {
          if (
            order.customer &&
            order.customer.id &&
            new Date(order.created_at) > thirtyDaysAgo
          ) {
            recentCustomerIds.add(order.customer.id);
          }
        });

        // Calculate purchase frequency
        const ordersByCustomer = {};
        orders.forEach((order) => {
          if (order.customer && order.customer.id) {
            const cid = order.customer.id;
            if (!ordersByCustomer[cid]) ordersByCustomer[cid] = [];
            ordersByCustomer[cid].push(new Date(order.created_at));
          }
        });

        let totalDaysBetween = 0;
        let pairCount = 0;
        Object.values(ordersByCustomer).forEach((dates) => {
          if (dates.length > 1) {
            dates.sort((a, b) => a - b);
            for (let i = 1; i < dates.length; i++) {
              const daysBetween =
                (dates[i] - dates[i - 1]) / (1000 * 60 * 60 * 24);
              totalDaysBetween += daysBetween;
              pairCount++;
            }
          }
        });

        const avgDaysBetweenOrders =
          pairCount > 0 ? Math.round(totalDaysBetween / pairCount) : 0;

        const html = `
          <div class="welcome">
            <h1>Customer Intelligence</h1>
            <p>Deep insights into your customer base and growth opportunities</p>
          </div>
          
          <div class="grid-4">
            <div class="card">
              <h3>Total Customers</h3>
              <div class="stat-large">${c.total}</div>
              <div class="stat-label">${recentCustomerIds.size} new this month</div>
            </div>
            <div class="card">
              <h3>Repeat Rate</h3>
              <div class="stat-large">${c.repeatRate}%</div>
              <div class="stat-label">${c.repeatCustomers} repeat customers</div>
            </div>
            <div class="card">
              <h3>Avg Lifetime Value</h3>
              <div class="stat-large">$${c.avgLifetimeValue}</div>
              <div class="stat-label">Per customer</div>
            </div>
            <div class="card">
              <h3>Purchase Frequency</h3>
              <div class="stat-large">${avgDaysBetweenOrders}</div>
              <div class="stat-label">Days between orders</div>
            </div>
          </div>
          
          <div class="grid-4" style="margin-bottom:24px">
            <div class="card" style="border-left:3px solid #fbbf24">
              <h3>VIP Customers</h3>
              <div class="stat-large" style="color:#fbbf24">${vipCustomers.length}</div>
              <div class="stat-label">Spent ${avgLTV > 0 ? "2x" : ""} above average</div>
            </div>
            <div class="card" style="border-left:3px solid #60a5fa">
              <h3>Regular Customers</h3>
              <div class="stat-large">${regularCustomers.length}</div>
              <div class="stat-label">Core customer base</div>
            </div>
            <div class="card" style="border-left:3px solid #34d399">
              <h3>New Customers</h3>
              <div class="stat-large">${newCustomers.length}</div>
              <div class="stat-label">First-time buyers</div>
            </div>
            <div class="card" style="border-left:3px solid #ef4444">
              <h3>At-Risk Customers</h3>
              <div class="stat-large">${atRiskCount}</div>
              <div class="stat-label">No order in 60+ days</div>
            </div>
          </div>
          
          <div class="grid-2" style="margin-bottom:24px">
            <div class="card">
              <h3>Customer Value Distribution</h3>
              <canvas id="customerValueChart" style="max-height:280px"></canvas>
            </div>
            <div class="card">
              <h3>Customer Growth (Last 30 Days)</h3>
              <canvas id="customerGrowthChart" style="max-height:280px"></canvas>
            </div>
          </div>
          
          <div class="grid-2">
            <div class="card">
              <h3>üèÜ VIP Customers (Top Spenders)</h3>
              ${
                vipCustomers.length === 0
                  ? `<p style="color:#64748b;padding:20px;text-align:center">No VIP customers yet</p>`
                  : `<div class="table-wrapper"><table class="data-table">
                    <thead><tr><th>Customer</th><th>Email</th><th>Orders</th><th>Total Spent</th><th>Status</th></tr></thead>
                    <tbody>${vipCustomers
                      .slice(0, 10)
                      .map(
                        (cu) => `
                      <tr>
                        <td>${cu.name}</td>
                        <td>${cu.email || "N/A"}</td>
                        <td>${cu.ordersCount}</td>
                        <td style="color:#fbbf24;font-weight:600">$${cu.totalSpent}</td>
                        <td><span class="insight-priority priority-medium">VIP</span></td>
                      </tr>`,
                      )
                      .join("")}
                    </tbody>
                  </table></div>`
              }
            </div>
            
            <div class="card">
              <h3>‚ö†Ô∏è At-Risk Customers</h3>
              <p style="color:#9ca7d6;font-size:13px;margin-bottom:16px">Haven't ordered in 60+ days ‚Äî time to re-engage!</p>
              ${
                atRiskCount === 0
                  ? `<p style="color:#64748b;padding:20px;text-align:center">üéâ All customers are actively ordering!</p>`
                  : `<div class="action-list">
                    <div class="action-item">
                      <div class="action-icon">üìß</div>
                      <div class="action-content">
                        <div class="action-title">Send Win-Back Email</div>
                        <div class="action-desc">Offer ${atRiskCount} customers a 15% discount to return</div>
                      </div>
                    </div>
                    <div class="action-item">
                      <div class="action-icon">üéÅ</div>
                      <div class="action-content">
                        <div class="action-title">Personalized Offers</div>
                        <div class="action-desc">Show them products similar to past purchases</div>
                      </div>
                    </div>
                    <div class="action-item">
                      <div class="action-icon">üí¨</div>
                      <div class="action-content">
                        <div class="action-title">Feedback Survey</div>
                        <div class="action-desc">Ask why they haven't returned</div>
                      </div>
                    </div>
                  </div>`
              }
            </div>
          </div>`;

        // Render charts
        setTimeout(() => renderCustomerCharts(c.topCustomers, orders), 100);
        return html;
      }

      // ============= CUSTOMER CHARTS =============
      function renderCustomerCharts(customers, orders) {
        if (!customers || customers.length === 0) return;

        // === CUSTOMER VALUE DISTRIBUTION (Pie Chart) ===
        const avgLTV =
          customers.reduce((s, c) => s + parseFloat(c.totalSpent), 0) /
          customers.length;
        const vip = customers.filter(
          (c) => parseFloat(c.totalSpent) > avgLTV * 2,
        ).length;
        const regular = customers.filter(
          (c) =>
            parseFloat(c.totalSpent) >= avgLTV &&
            parseFloat(c.totalSpent) <= avgLTV * 2,
        ).length;
        const occasional = customers.filter(
          (c) => parseFloat(c.totalSpent) < avgLTV,
        ).length;

        const valueCtx = document.getElementById("customerValueChart");
        if (valueCtx) {
          new Chart(valueCtx, {
            type: "doughnut",
            data: {
              labels: [
                "VIP Customers",
                "Regular Customers",
                "Occasional Buyers",
              ],
              datasets: [
                {
                  data: [vip, regular, occasional],
                  backgroundColor: ["#fbbf24", "#60a5fa", "#9ca7d6"],
                  borderColor: "#0f172a",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: "#9ca7d6", padding: 15, font: { size: 12 } },
                },
                tooltip: {
                  backgroundColor: "rgba(15, 23, 42, 0.95)",
                  titleColor: "#e5ecff",
                  bodyColor: "#9ca7d6",
                  borderColor: "rgba(148, 163, 184, 0.2)",
                  borderWidth: 1,
                  padding: 12,
                  callbacks: {
                    label: (ctx) => `${ctx.label}: ${ctx.parsed} customers`,
                  },
                },
              },
            },
          });
        }

        // === CUSTOMER GROWTH CHART (Last 30 days) ===
        const dailyCustomers = {};
        const today = new Date();

        for (let i = 29; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split("T")[0];
          dailyCustomers[key] = { new: 0, returning: 0 };
        }

        const seenCustomers = new Set();
        orders
          .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
          .forEach((order) => {
            if (order.customer && order.customer.id) {
              const dateKey = order.created_at.split("T")[0];
              const customerId = order.customer.id;

              if (dailyCustomers.hasOwnProperty(dateKey)) {
                if (seenCustomers.has(customerId)) {
                  dailyCustomers[dateKey].returning++;
                } else {
                  dailyCustomers[dateKey].new++;
                  seenCustomers.add(customerId);
                }
              }
            }
          });

        const growthLabels = Object.keys(dailyCustomers).map((d) => {
          const date = new Date(d);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        });

        const newCustomerData = Object.values(dailyCustomers).map((d) => d.new);
        const returningCustomerData = Object.values(dailyCustomers).map(
          (d) => d.returning,
        );

        const growthCtx = document.getElementById("customerGrowthChart");
        if (growthCtx) {
          new Chart(growthCtx, {
            type: "bar",
            data: {
              labels: growthLabels,
              datasets: [
                {
                  label: "New Customers",
                  data: newCustomerData,
                  backgroundColor: "rgba(52, 211, 153, 0.8)",
                  borderColor: "#34d399",
                  borderWidth: 1,
                },
                {
                  label: "Returning Customers",
                  data: returningCustomerData,
                  backgroundColor: "rgba(96, 165, 250, 0.8)",
                  borderColor: "#60a5fa",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: "#9ca7d6", padding: 15, font: { size: 12 } },
                },
                tooltip: {
                  backgroundColor: "rgba(15, 23, 42, 0.95)",
                  titleColor: "#e5ecff",
                  bodyColor: "#9ca7d6",
                  borderColor: "rgba(148, 163, 184, 0.2)",
                  borderWidth: 1,
                  padding: 12,
                },
              },
              scales: {
                x: {
                  stacked: true,
                  grid: { display: false },
                  ticks: {
                    color: "#9ca7d6",
                    maxRotation: 45,
                    minRotation: 45,
                    font: { size: 10 },
                  },
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  grid: { color: "rgba(148, 163, 184, 0.1)" },
                  ticks: { color: "#9ca7d6", precision: 0 },
                },
              },
            },
          });
        }
      }

      // ============= CONNECT SHOPIFY =============
      function renderConnectShopify() {
        return `
          <div class="card connect-cta">
            <h2>Connect Your Shopify Store</h2>
            <p>Aervo needs access to your Shopify data to provide AI-powered insights,<br>
            sales analytics, inventory tracking, and smart recommendations.</p>
            <button class="btn-primary" onclick="connectShopify()">üõçÔ∏è Connect Shopify Store</button>
          </div>
          <div class="card" style="margin-top:24px">
            <h3 style="margin-bottom:16px;color:#e5ecff">What You'll Get:</h3>
            <ul class="action-list">
              <li class="action-item"><div class="action-icon">ü§ñ</div><div class="action-content"><div class="action-title">AI-Powered Insights</div><div class="action-desc">Smart recommendations to grow your business</div></div></li>
              <li class="action-item"><div class="action-icon">üìä</div><div class="action-content"><div class="action-title">Real-Time Analytics</div><div class="action-desc">Track sales, revenue, and performance</div></div></li>
              <li class="action-item"><div class="action-icon">üì¶</div><div class="action-content"><div class="action-title">Inventory Management</div><div class="action-desc">Never run out of your best-sellers</div></div></li>
              <li class="action-item"><div class="action-icon">üë•</div><div class="action-content"><div class="action-title">Customer Intelligence</div><div class="action-desc">Understand and grow your customer base</div></div></li>
            </ul>
          </div>`;
      }

      // ============= HELPER: ORDERS TABLE =============
      function renderOrdersTable(orders) {
        if (!orders || orders.length === 0)
          return `<p style="color:#64748b;padding:20px;text-align:center">No orders yet</p>`;
        return `<div class="table-wrapper"><table class="data-table">
          <thead><tr><th>Order #</th><th>Customer</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th></tr></thead>
          <tbody>${orders
            .map(
              (o) => `
            <tr>
              <td>${o.name || o.order_number}</td>
              <td>${o.customer ? (o.customer.first_name || "") + " " + (o.customer.last_name || "").trim() || "Guest" : "Guest"}</td>
              <td>${new Date(o.created_at).toLocaleDateString()}</td>
              <td>${o.line_items ? o.line_items.length : 0}</td>
              <td>$${parseFloat(o.total_price || 0).toFixed(2)}</td>
              <td><span class="stat-change positive" style="margin:0">${o.financial_status}</span></td>
            </tr>`,
            )
            .join("")}
          </tbody>
        </table></div>`;
      }

      // ============= HELPER: ACTION ITEMS =============
      function renderActionItems(inv) {
        const items = [];
        if (inv && inv.outOfStock.length > 0)
          items.push({
            icon: "üì¶",
            title: `Restock ${inv.outOfStock.length} out-of-stock items`,
            desc: "Preventing potential lost revenue",
          });
        if (inv && inv.lowStock.length > 0)
          items.push({
            icon: "üí∞",
            title: `Review ${inv.lowStock.length} low-stock products`,
            desc: "Set reorder points to avoid stockouts",
          });
        if (items.length === 0)
          items.push({
            icon: "‚úÖ",
            title: "All caught up!",
            desc: "No urgent actions needed right now",
          });
        return `<ul class="action-list">${items
          .map(
            (a) => `
          <li class="action-item">
            <div class="action-icon">${a.icon}</div>
            <div class="action-content">
              <div class="action-title">${a.title}</div>
              <div class="action-desc">${a.desc}</div>
            </div>
          </li>`,
          )
          .join("")}</ul>`;
      }

      // ============= HELPER: AI INSIGHTS =============
      function generateInsights(d, inv) {
        const insights = [];
        if (inv && inv.outOfStock.length > 0) {
          insights.push({
            priority: "high",
            label: "HIGH PRIORITY",
            title: `${inv.outOfStock.length} product${inv.outOfStock.length > 1 ? "s are" : " is"} out of stock`,
            desc: `Restock to avoid lost sales. Top priority: ${inv.outOfStock[0]?.productTitle || "unknown"}`,
          });
        }
        if (d && parseFloat(d.revenue.change) > 10) {
          insights.push({
            priority: "medium",
            label: "OPPORTUNITY",
            title: `Revenue is up ${d.revenue.change}% this month`,
            desc: "Great momentum! Consider expanding your marketing to capitalize on this growth.",
          });
        }
        if (d && d.orders.today > d.orders.yesterday) {
          insights.push({
            priority: "low",
            label: "INSIGHT",
            title: "Orders are trending up today",
            desc: `${d.orders.today} orders so far vs ${d.orders.yesterday} yesterday.`,
          });
        }
        insights.push({
          priority: "low",
          label: "INSIGHT",
          title: "Monitor customer retention",
          desc: "Focus on repeat customers to increase lifetime value and sustainable growth.",
        });
        return insights.slice(0, 3);
      }

      // ============= CONNECT SHOPIFY FUNCTION =============

      function connectShopify() {
        const shop = prompt(
          "Enter your Shopify store domain (e.g., your-store.myshopify.com):",
        );
        if (!shop) return;

        const normalized = shop.trim().toLowerCase();
        if (!normalized.includes(".myshopify.com")) {
          alert("Please enter a valid Shopify domain ending in .myshopify.com");
          return;
        }

        window.location.href = `${BACKEND_URL}/auth/shopify?shop=${encodeURIComponent(normalized)}`;
      }

      // ============= CHAT =============
      let isAIThinking = false;

      async function sendMessage() {
        if (isAIThinking) return;
        const input = document.getElementById("chatInput");
        const messages = document.getElementById("chatMessages");
        const message = input.value.trim();
        if (!message) return;

        const userMsg = document.createElement("div");
        userMsg.className = "chat-message user";
        userMsg.textContent = message;
        messages.appendChild(userMsg);
        input.value = "";
        messages.scrollTop = messages.scrollHeight;

        isAIThinking = true;
        const typingEl = document.createElement("div");
        typingEl.className = "chat-message ai";
        typingEl.id = "typingIndicator";
        typingEl.innerHTML =
          "<em style=\'color:#64748b\'>Aervo is thinking...</em>";
        messages.appendChild(typingEl);
        messages.scrollTop = messages.scrollHeight;
        input.disabled = true;
        document.querySelector(".btn-send").disabled = true;

        try {
          const response = await fetch(`${BACKEND_URL}/api/ai/chat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              message,
              shopOrigin: shopData ? shopData.shopOrigin : null,
            }),
          });
          const data = await response.json();
          document.getElementById("typingIndicator")?.remove();
          if (data.success) {
            const aiMsg = document.createElement("div");
            aiMsg.className = "chat-message ai";
            aiMsg.innerHTML = data.reply
              .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
              .replace(/\n\n/g, "<br><br>")
              .replace(/\n/g, "<br>");
            messages.appendChild(aiMsg);
          } else {
            throw new Error(data.message || "Failed to get response");
          }
        } catch (err) {
          document.getElementById("typingIndicator")?.remove();
          const errMsg = document.createElement("div");
          errMsg.className = "chat-message ai";
          errMsg.textContent =
            "Sorry, I had trouble responding. Please try again.";
          messages.appendChild(errMsg);
        }

        isAIThinking = false;
        input.disabled = false;
        document.querySelector(".btn-send").disabled = false;
        input.focus();
        messages.scrollTop = messages.scrollHeight;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const chatInput = document.getElementById("chatInput");
        if (chatInput)
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
          });
      });

      // ============= SUGGESTION HELPER =============
      function askSuggestion(el) {
        const input = document.getElementById("chatInput");
        if (input) {
          input.value = el.textContent;
          input.focus();
          sendMessage();
        }
      }

      // ============= BOOT =============
      loadUserData();
    </script>
  </body>
</html>
